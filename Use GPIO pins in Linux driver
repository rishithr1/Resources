Perfect üëç ‚Äî now we‚Äôre stepping from hello module ‚Üí real hardware control.

You asked:

‚ÄúUse GPIO pins in Linux driver‚Äù

This is a core BSP / embedded Linux skill used in:
	‚Ä¢	Switch bring-up
	‚Ä¢	Fan control
	‚Ä¢	LED control
	‚Ä¢	Reset lines
	‚Ä¢	Power enable pins
	‚Ä¢	CPLD signaling

I‚Äôll explain end-to-end:

1Ô∏è‚É£ What GPIO is
2Ô∏è‚É£ Why drivers use GPIO
3Ô∏è‚É£ GPIO architecture in Linux
4Ô∏è‚É£ APIs used
5Ô∏è‚É£ Full kernel module example
6Ô∏è‚É£ Line-by-line explanation
7Ô∏è‚É£ Device Tree relation
8Ô∏è‚É£ Build + run commands
9Ô∏è‚É£ Debugging
üîü Real switch use cases

‚∏ª

1Ô∏è‚É£ First ‚Äî What is GPIO?

GPIO = General Purpose Input Output

Simple:

üëâ A programmable electrical pin on a chip.

It can act as:
	‚Ä¢	Input ‚Üí Read signal
	‚Ä¢	Output ‚Üí Send signal

‚∏ª

2Ô∏è‚É£ Real-Life Analogy üîò

Think of GPIO like a wall switch:
	‚Ä¢	ON ‚Üí Send voltage
	‚Ä¢	OFF ‚Üí No voltage

You can:
	‚Ä¢	Turn LED on/off
	‚Ä¢	Reset hardware
	‚Ä¢	Detect button press

‚∏ª

3Ô∏è‚É£ GPIO Inside Networking Switch

GPIO pins control:

Function	Example
Fan enable	Turn fan ON
PSU detect	Power status
LED control	Port status
ASIC reset	Hardware reset
SFP presence	Optics detect

So BSP drivers use GPIO heavily.

‚∏ª

4Ô∏è‚É£ Linux GPIO Architecture

Flow:

Application
   ‚Üì
Sysfs / ioctl
   ‚Üì
GPIO driver API
   ‚Üì
GPIO controller driver
   ‚Üì
Hardware pin

Kernel abstracts physical pins.

‚∏ª

5Ô∏è‚É£ GPIO Kernel APIs (Modern)

Key functions:

gpio_request()
gpio_direction_output()
gpio_set_value()
gpio_get_value()
gpio_free()

Newer kernels use gpiod_* APIs, but basic GPIO still common in BSP.

‚∏ª

6Ô∏è‚É£ Minimal GPIO Kernel Module Example

This module:
	‚Ä¢	Requests GPIO
	‚Ä¢	Sets it as output
	‚Ä¢	Toggles HIGH
	‚Ä¢	Cleans up on exit

‚∏ª


#include <linux/module.h>
#include <linux/kernel.h>
#include <linux/init.h>
#include <linux/gpio.h>

#define GPIO_PIN 21   // Change as per board

static int __init gpio_init(void)
{
    int ret;

    printk(KERN_INFO "GPIO Module: Init\n");

    /* Request GPIO */
    ret = gpio_request(GPIO_PIN, "gpio_test");
    if (ret) {
        printk(KERN_ERR "Failed to request GPIO %d\n", GPIO_PIN);
        return ret;
    }

    /* Set direction as output */
    gpio_direction_output(GPIO_PIN, 1);

    printk(KERN_INFO "GPIO %d set to HIGH\n", GPIO_PIN);

    return 0;
}

static void __exit gpio_exit(void)
{
    gpio_set_value(GPIO_PIN, 0);
    gpio_free(GPIO_PIN);

    printk(KERN_INFO "GPIO Module: Exit\n");
}

module_init(gpio_init);
module_exit(gpio_exit);

MODULE_LICENSE("GPL");
MODULE_AUTHOR("V S Rishith Reddy");
MODULE_DESCRIPTION("Simple GPIO Driver Example");


‚∏ª

7Ô∏è‚É£ Line-By-Line Explanation

‚∏ª

Include headers

#include <linux/gpio.h>

Provides GPIO APIs.

‚∏ª

Define GPIO number

#define GPIO_PIN 21

Pin number depends on board mapping.

‚∏ª

Request GPIO

gpio_request(GPIO_PIN, "gpio_test");

Reserves pin for this driver.

Prevents conflicts.

‚∏ª

Set direction

gpio_direction_output(GPIO_PIN, 1);

Configures pin as output.

1 ‚Üí HIGH voltage.

‚∏ª

Set value

gpio_set_value(GPIO_PIN, 1);

Turns signal ON.

Used for LEDs, resets, power enable.

‚∏ª

Cleanup

gpio_free(GPIO_PIN);

Releases pin when module removed.

‚∏ª

8Ô∏è‚É£ GPIO Hardware View

Shows how pins connect to LEDs, sensors, etc.

‚∏ª

9Ô∏è‚É£ Build Makefile

obj-m += gpio_test.o

KDIR := /lib/modules/$(shell uname -r)/build
PWD  := $(shell pwd)

all:
	make -C $(KDIR) M=$(PWD) modules

clean:
	make -C $(KDIR) M=$(PWD) clean


‚∏ª

üîü Build + Run Commands

‚∏ª

Build

make


‚∏ª

Insert module

sudo insmod gpio_test.ko


‚∏ª

Check logs

dmesg | tail


‚∏ª

Remove module

sudo rmmod gpio_test


‚∏ª

1Ô∏è‚É£1Ô∏è‚É£ GPIO Input Example

Read button/signal:

gpio_direction_input(GPIO_PIN);
int val = gpio_get_value(GPIO_PIN);

Used for:
	‚Ä¢	PSU presence detect
	‚Ä¢	Fan fault detect
	‚Ä¢	SFP insert detect

‚∏ª

1Ô∏è‚É£2Ô∏è‚É£ GPIO via Device Tree

Modern embedded systems define GPIO in DTS:

Example:

led_gpio {
    gpios = <&gpio1 5 GPIO_ACTIVE_HIGH>;
};

Driver reads mapping dynamically.

Used in ARM / switch platforms.

‚∏ª

1Ô∏è‚É£3Ô∏è‚É£ Real Switch Use Cases

GPIO Function	Example
Reset ASIC	Toggle reset line
Control LEDs	Link/activity
Fan enable	Thermal control
PSU alarm	Fault signal
Optics detect	SFP presence

DiagOS tests these GPIO paths.

‚∏ª

1Ô∏è‚É£4Ô∏è‚É£ Common GPIO Errors

Error	Cause
gpio_request fail	Pin busy
No signal change	Wrong pin
Kernel crash	Invalid mapping
Always LOW	Pull-down resistor

Hardware + software both matter.

‚∏ª

1Ô∏è‚É£5Ô∏è‚É£ Old vs New GPIO APIs

Old API	New API
gpio_*	gpiod_*
Number based	Descriptor based
Legacy BSP	Modern kernel

You‚Äôll see both in switch codebases.

‚∏ª

1Ô∏è‚É£6Ô∏è‚É£ Office Explanation

Beginner:

‚ÄúGPIO drivers control hardware pins.‚Äù

Expert:

‚ÄúGPIO kernel modules configure and manipulate SoC pin states for platform control functions such as resets, LED signaling, and presence detection.‚Äù

‚∏ª

1Ô∏è‚É£7Ô∏è‚É£ Memory Shortcut

gpio_request ‚Üí Reserve pin
gpio_direction ‚Üí Set input/output
gpio_set_value ‚Üí Write signal
gpio_get_value ‚Üí Read signal
gpio_free ‚Üí Release pin


‚∏ª

How GPIO Fits Into Your Switch BSP Stack

Kernel boots
   ‚Üì
GPIO driver loads
   ‚Üì
Pins initialized
   ‚Üì
Fans / LEDs / resets controlled
   ‚Üì
DiagOS tests GPIO signals

GPIO = basic hardware control layer.

‚∏ª

If you want next hardware-driver topics:
	‚Ä¢	I¬≤C driver coding
	‚Ä¢	EEPROM read driver
	‚Ä¢	MDIO/PHY driver
	‚Ä¢	PCIe driver probe
	‚Ä¢	Interrupt-based GPIO driver

All directly used in switch BSP üëç
